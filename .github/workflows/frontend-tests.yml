name: Frontend Unit Tests

on:
  push:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-tests.yml'
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-tests.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Clean install (remove node_modules and lock file)
      working-directory: ./frontend
      run: |
        rm -rf node_modules package-lock.json
        npm install --verbose

    - name: List karma plugins in node_modules
      working-directory: ./frontend
      run: ls -lh node_modules/karma-chrome-launcher

    - name: List all installed modules
      working-directory: ./frontend
      run: npm list --depth=0

    - name: Ensure Chrome dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libnss3 libatk-bridge2.0-0 libxss1 libgtk-3-0 libasound2

    - name: Run tests with extra browser logging
      working-directory: ./frontend
      run: |
        npx karma --show-config test -- --browsers=ChromeHeadless --watch=false --code-coverage || true
        npm test -- --browsers=ChromeHeadless --watch=false --code-coverage

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      with:
        files: ./frontend/coverage/lcov.info
        flags: frontend
        fail_ci_if_error: false

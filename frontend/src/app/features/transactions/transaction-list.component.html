<div class="transactions-list-section">
  <div class="section-header">
    <h2>Transactions</h2>
    <button class="btn-add-transaction" (click)="onCreateTransaction()" title="Add new transaction">
      <span class="add-icon">+</span>
    </button>
  </div>

  <!-- Filter Section with Accordion -->
  <div class="filter-section">
    <button class="filter-toggle" (click)="toggleFilters()">
      <span class="filter-toggle-icon" [class.expanded]="filtersExpanded">‚ñ∂</span>
      <h3>Filters</h3>
    </button>
    <div class="filter-content" [class.expanded]="filtersExpanded">
      <form [formGroup]="filterForm" class="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label for="filter_start_date">Start Date</label>
          <input
            type="date"
            id="filter_start_date"
            formControlName="start_date"
            class="form-control"
          />
        </div>
        <div class="filter-group">
          <label for="filter_end_date">End Date</label>
          <input
            type="date"
            id="filter_end_date"
            formControlName="end_date"
            class="form-control"
          />
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filter_type">Transaction Type</label>
          <select id="filter_type" formControlName="transaction_type" class="form-control">
            <option [value]="null">All</option>
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter_category">Category</label>
          <select id="filter_category" formControlName="category_id" class="form-control">
            <option [value]="null">All</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
      </div>
      <div class="filter-row">
        <div class="filter-group">
          <label for="filter_beneficiary">Beneficiary</label>
          <select id="filter_beneficiary" formControlName="beneficiary_id" class="form-control">
            <option [value]="null">All</option>
            <option *ngFor="let beneficiary of beneficiaries" [value]="beneficiary.id">
              {{ beneficiary.name }}
            </option>
          </select>
        </div>
      </div>
      <div class="filter-buttons">
        <button type="button" class="btn btn-outline" (click)="setLastMonth()">Last Month</button>
        <button type="button" class="btn btn-outline" (click)="setLast2Months()">Last 2 Months</button>
        <button type="button" class="btn btn-outline" (click)="clearFilters()">Clear Filters</button>
        <button type="button" class="btn btn-primary" (click)="applyFilters()">Apply Filters</button>
      </div>
    </form>
    </div>
  </div>

  <div class="summary" *ngIf="transactions.length > 0">
    <div class="summary-item income">
      <span class="label">Total Income:</span>
      <span class="value">${{ totalIncome.toFixed(2) }}</span>
    </div>
    <div class="summary-item expense">
      <span class="label">Total Expenses:</span>
      <span class="value">${{ totalExpenses.toFixed(2) }}</span>
    </div>
    <div class="summary-item balance">
      <span class="label">Balance:</span>
      <span class="value" [class.negative]="balance < 0">${{ balance.toFixed(2) }}</span>
    </div>
  </div>

  <div class="transactions-list" *ngIf="transactions.length > 0; else noTransactions">
    <ng-container *ngFor="let monthGroup of transactionsGroupedByMonth">
      <!-- Monthly Subtotal Header (Clickable for collapse) -->
      <div class="month-subtotal-row clickable" (click)="toggleMonthCollapse(monthGroup.monthKey)">
        <div class="month-collapse-indicator">
          <span class="collapse-icon" [class.collapsed]="isMonthCollapsed(monthGroup.monthKey)">‚ñº</span>
        </div>
        <div class="month-label">{{ monthGroup.monthLabel }}</div>
        <div class="month-totals">
          <span class="month-income">+${{ monthGroup.income.toFixed(2) }}</span>
          <span class="month-expenses">-${{ monthGroup.expenses.toFixed(2) }}</span>
          <span class="month-balance" [class.negative]="monthGroup.balance < 0">
            {{ monthGroup.balance >= 0 ? '+' : '' }}${{ monthGroup.balance.toFixed(2) }}
          </span>
        </div>
      </div>

      <!-- Transactions for this month (collapsible) -->
      <div class="month-transactions" [class.collapsed]="isMonthCollapsed(monthGroup.monthKey)">
        <div class="transaction-item" *ngFor="let transaction of monthGroup.transactions" [class]="transaction.type">
          <div class="transaction-info">
            <div class="transaction-description">{{ transaction.description }}</div>
            <div class="transaction-meta">
              <span class="transaction-category">{{ transaction.category?.name }}</span>
              <span class="transaction-beneficiary" *ngIf="transaction.beneficiary">‚Ä¢ {{ transaction.beneficiary.name }}</span>
            </div>
            <div class="transaction-tags" *ngIf="transaction.tags && transaction.tags.length > 0">
              <span class="tag" *ngFor="let tag of transaction.tags">{{ tag }}</span>
            </div>
            <div class="transaction-notes" *ngIf="transaction.notes">
              <span class="notes-preview">{{ transaction.notes | slice:0:100 }}{{ transaction.notes.length > 100 ? '...' : '' }}</span>
            </div>
            <div class="transaction-dates">
              <span class="transaction-date">Date: {{ formatDate(transaction.transaction_date) }}</span>
              <span class="transaction-created">Created: {{ formatDate(transaction.created_at) }}</span>
            </div>
            <div class="transaction-image" *ngIf="transaction.image_path">
              <button type="button" class="btn-view-image" (click)="viewImage(transaction.image_path)">
                üñºÔ∏è View Image
              </button>
            </div>
          </div>
          <div class="transaction-amount" [class]="transaction.type">
            {{ transaction.type === 'income' ? '+' : '-' }}${{ transaction.amount.toFixed(2) }}
          </div>
          <div class="transaction-actions">
            <button class="btn-edit" (click)="onEditTransaction(transaction)">Edit</button>
            <button class="btn-delete" (click)="deleteTransaction(transaction.id)">Delete</button>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Pagination Controls -->
    <div class="pagination-controls">
      <button class="btn btn-outline" (click)="goToFirstPage()" [disabled]="currentPage === 0">
        ‚ü™ First
      </button>
      <button class="btn btn-outline" (click)="goToPreviousPage()" [disabled]="currentPage === 0">
        ‚Üê Previous
      </button>
      <span class="page-indicator">Page {{ currentPage + 1 }}</span>
      <button class="btn btn-outline" (click)="goToNextPage()" [disabled]="!hasMorePages">
        Next ‚Üí
      </button>
    </div>
  </div>

  <ng-template #noTransactions>
    <div class="no-transactions">
      <p>No transactions yet. Add your first transaction above!</p>
    </div>
  </ng-template>
</div>

<!-- Image Modal -->
<div class="image-modal" *ngIf="viewingImageBlobUrl" (click)="closeImageModal()">
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <button class="btn-close-modal" (click)="closeImageModal()">√ó</button>
    <img [src]="viewingImageBlobUrl" alt="Transaction image" />
  </div>
</div>

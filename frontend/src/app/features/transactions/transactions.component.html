<div class="transactions-container">
  <header class="header">
    <h1>Budget Tracker</h1>
    <div class="user-info" *ngIf="currentUser">
      <span>Welcome, {{ currentUser.name }}</span>
      <button class="btn btn-secondary" (click)="logout()">Logout</button>
    </div>
  </header>

  <div class="content">
    <div class="transaction-form-section">
      <h2>{{ editMode ? 'Edit Transaction' : 'Add Transaction' }}</h2>
      <form [formGroup]="transactionForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label for="description">Description</label>
            <input
              type="text"
              id="description"
              formControlName="description"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="amount">Amount</label>
            <input
              type="number"
              id="amount"
              formControlName="amount"
              class="form-control"
              step="0.01"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="transaction_date">Transaction Date</label>
            <input
              type="datetime-local"
              id="transaction_date"
              formControlName="transaction_date"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="type">Type</label>
            <select id="type" formControlName="type" class="form-control" (change)="onTypeChange()">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="category_id">Category</label>
            <select id="category_id" formControlName="category_id" class="form-control">
              <option value="">Select Category</option>
              <option *ngFor="let category of filteredCategories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="beneficiary_id">Beneficiary</label>
            <select id="beneficiary_id" formControlName="beneficiary_id" class="form-control">
              <option value="">Select Beneficiary</option>
              <option *ngFor="let beneficiary of beneficiaries" [value]="beneficiary.id">
                {{ beneficiary.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group image-upload-group">
            <label>Receipt Image (Optional)</label>
            <div class="image-upload-controls">
              <input
                type="file"
                #fileInput
                accept="image/*"
                (change)="onFileSelected($event)"
                style="display: none"
              />
              <input
                type="file"
                #cameraInput
                accept="image/*"
                capture="environment"
                (change)="onFileSelected($event)"
                style="display: none"
              />
              <button type="button" class="btn btn-outline" (click)="fileInput.click()">
                üìÅ Choose File
              </button>
              <button type="button" class="btn btn-outline" (click)="cameraInput.click()">
                üì∑ Take Photo
              </button>
            </div>
            <div class="image-preview" *ngIf="selectedImagePreview">
              <img [src]="selectedImagePreview" alt="Selected image preview" />
              <button type="button" class="btn-remove-image" (click)="removeSelectedImage()">√ó</button>
            </div>
            <div class="upload-status" *ngIf="uploadingImage">Uploading image...</div>
          </div>
        </div>

        <div class="error-message" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>

        <div class="form-buttons">
          <button type="submit" class="btn btn-primary" [disabled]="transactionForm.invalid || loading || uploadingImage">
            {{ loading ? (editMode ? 'Saving...' : 'Adding...') : (editMode ? 'Save Changes' : 'Add Transaction') }}
          </button>
          <button type="button" class="btn btn-secondary" *ngIf="editMode" (click)="cancelEdit()">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <div class="transactions-list-section">
      <h2>Transactions</h2>

      <!-- Filter Section -->
      <div class="filter-section">
        <h3>Filters</h3>
        <form [formGroup]="filterForm" class="filter-form">
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter_start_date">Start Date</label>
              <input
                type="date"
                id="filter_start_date"
                formControlName="start_date"
                class="form-control"
              />
            </div>
            <div class="filter-group">
              <label for="filter_end_date">End Date</label>
              <input
                type="date"
                id="filter_end_date"
                formControlName="end_date"
                class="form-control"
              />
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter_type">Transaction Type</label>
              <select id="filter_type" formControlName="transaction_type" class="form-control">
                <option [value]="null">All</option>
                <option value="expense">Expense</option>
                <option value="income">Income</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="filter_category">Category</label>
              <select id="filter_category" formControlName="category_id" class="form-control">
                <option [value]="null">All</option>
                <option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label for="filter_beneficiary">Beneficiary</label>
              <select id="filter_beneficiary" formControlName="beneficiary_id" class="form-control">
                <option [value]="null">All</option>
                <option *ngFor="let beneficiary of beneficiaries" [value]="beneficiary.id">
                  {{ beneficiary.name }}
                </option>
              </select>
            </div>
          </div>
          <div class="filter-buttons">
            <button type="button" class="btn btn-outline" (click)="setLastMonth()">Last Month</button>
            <button type="button" class="btn btn-outline" (click)="setLast2Months()">Last 2 Months</button>
            <button type="button" class="btn btn-outline" (click)="clearFilters()">Clear Filters</button>
            <button type="button" class="btn btn-primary" (click)="applyFilters()">Apply Filters</button>
          </div>
        </form>
      </div>

      <div class="summary" *ngIf="transactions.length > 0">
        <div class="summary-item income">
          <span class="label">Total Income:</span>
          <span class="value">${{ totalIncome.toFixed(2) }}</span>
        </div>
        <div class="summary-item expense">
          <span class="label">Total Expenses:</span>
          <span class="value">${{ totalExpenses.toFixed(2) }}</span>
        </div>
        <div class="summary-item balance">
          <span class="label">Balance:</span>
          <span class="value" [class.negative]="balance < 0">${{ balance.toFixed(2) }}</span>
        </div>
      </div>

      <div class="transactions-list" *ngIf="transactions.length > 0; else noTransactions">
        <div class="transaction-item" *ngFor="let transaction of transactions" [class]="transaction.type">
          <div class="transaction-info">
            <div class="transaction-description">{{ transaction.description }}</div>
            <div class="transaction-meta">
              <span class="transaction-category">{{ transaction.category?.name }}</span>
              <span class="transaction-beneficiary" *ngIf="transaction.beneficiary">‚Ä¢ {{ transaction.beneficiary.name }}</span>
            </div>
            <div class="transaction-dates">
              <span class="transaction-date">Date: {{ formatDate(transaction.transaction_date) }}</span>
              <span class="transaction-created">Created: {{ formatDate(transaction.created_at) }}</span>
            </div>
            <div class="transaction-image" *ngIf="transaction.image_path">
              <button type="button" class="btn-view-image" (click)="viewImage(transaction.image_path)">
                üñºÔ∏è View Receipt
              </button>
            </div>
          </div>
          <div class="transaction-amount" [class]="transaction.type">
            {{ transaction.type === 'income' ? '+' : '-' }}${{ transaction.amount.toFixed(2) }}
          </div>
          <div class="transaction-actions">
            <button class="btn-edit" (click)="editTransaction(transaction)">Edit</button>
            <button class="btn-delete" (click)="deleteTransaction(transaction.id)">Delete</button>
          </div>
        </div>
      </div>

      <ng-template #noTransactions>
        <div class="no-transactions">
          <p>No transactions yet. Add your first transaction above!</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" *ngIf="viewingImage" (click)="closeImageModal()">
    <div class="image-modal-content" (click)="$event.stopPropagation()">
      <button class="btn-close-modal" (click)="closeImageModal()">√ó</button>
      <img [src]="viewingImage" alt="Transaction image" />
    </div>
  </div>
</div>


<div class="form-container">
    <h2>{{ isEditMode ? ('gifts.editGiftEntry' | translate) : ('gifts.addGiftEntry' | translate) }}</h2>

    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
    </div>

    <form (ngSubmit)="onSubmit()" [formGroup]="form">
        <div class="form-group">
            <label for="direction">{{ 'gifts.giftType' | translate }} *</label>
            <select formControlName="direction" id="direction">
                <option *ngFor="let dir of directions" [value]="dir">
                    {{ formatDirection(dir) }}
                </option>
            </select>
        </div>

        <div class="form-group">
            <label for="person_id">{{ form.get('direction')?.value === 'received' ? ('gifts.from' | translate) : ('gifts.to' | translate) }} *</label>
            <div class="beneficiary-select-wrapper">
                <select formControlName="person_id" id="person_id">
                    <option [ngValue]="null" disabled>{{ 'gifts.selectPerson' | translate }}</option>
                    <option *ngFor="let b of beneficiaries" [ngValue]="b.id">
                        {{ b.name }}
                    </option>
                </select>
                <button type="button" class="btn-add-new" (click)="toggleNewBeneficiaryInput()" [title]="showNewBeneficiaryInput ? ('common.cancel' | translate) : ('gifts.addNewPerson' | translate)">
                    {{ showNewBeneficiaryInput ? 'Ã—' : '+' }}
                </button>
            </div>
            <div class="new-beneficiary-input" *ngIf="showNewBeneficiaryInput">
                <input
                    type="text"
                    [(ngModel)]="newBeneficiaryName"
                    [ngModelOptions]="{standalone: true}"
                    [placeholder]="'gifts.enterPersonName' | translate"
                    (keyup.enter)="createNewBeneficiary()"
                />
                <button
                    type="button"
                    class="btn btn-primary btn-small"
                    (click)="createNewBeneficiary()"
                    [disabled]="!newBeneficiaryName.trim() || creatingBeneficiary"
                >
                    {{ creatingBeneficiary ? ('common.creating' | translate) : ('common.create' | translate) }}
                </button>
            </div>
            <div *ngIf="form.get('person_id')?.invalid && form.get('person_id')?.touched" class="error">
                {{ 'gifts.personRequired' | translate }}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">{{ 'common.amount' | translate }} *</label>
                <input
                        formControlName="amount"
                        id="amount"
                        min="0.01"
                        placeholder="0.00"
                        step="0.01"
                        type="number"
                />
                <div *ngIf="form.get('amount')?.invalid && form.get('amount')?.touched" class="error">
                    {{ 'gifts.amountRequired' | translate }}
                </div>
            </div>

            <div class="form-group">
                <label for="gift_date">{{ 'common.date' | translate }} *</label>
                <input
                        formControlName="gift_date"
                        id="gift_date"
                        type="date"
                />
            </div>
        </div>

        <div class="form-group">
            <label for="description">{{ 'common.description' | translate }}</label>
            <input
                    formControlName="description"
                    id="description"
                    placeholder="e.g., Birthday money"
                    type="text"
            />
        </div>

        <!-- Transaction Linking -->
        <div class="form-group">
            <label>{{ 'gifts.linkToTransaction' | translate }}</label>
            <div class="transaction-picker">
                <div *ngIf="selectedTransaction; else noTransaction" class="selected-transaction">
          <span class="transaction-info">
            {{ formatDate(selectedTransaction.transaction_date) }} -
              {{ selectedTransaction.description }}
              ({{ formatCurrency(selectedTransaction.amount) }})
          </span>
                    <button (click)="selectTransaction(null)" class="btn-clear" type="button">âœ•</button>
                </div>
                <ng-template #noTransaction>
                    <button (click)="toggleTransactionPicker()" class="btn-link" type="button">
                        ðŸ”— {{ showTransactionPicker ? ('gifts.hideTransaction' | translate) : ('gifts.selectTransaction' | translate) }}
                    </button>
                </ng-template>

                <div *ngIf="showTransactionPicker" class="transaction-list">
                    <div class="transaction-search-hint">
                        {{ form.get('direction')?.value === 'received' ? ('gifts.showingIncomeTransactions' | translate) : ('gifts.showingExpenseTransactions' | translate) }}
                    </div>
                    <div
                            (click)="selectTransaction(t)"
                            *ngFor="let t of filteredTransactions | slice:0:10"
                            class="transaction-option"
                    >
                        <span class="transaction-date">{{ formatDate(t.transaction_date) }}</span>
                        <span class="transaction-desc">{{ t.description }}</span>
                        <span class="transaction-amount">{{ formatCurrency(t.amount) }}</span>
                    </div>
                    <div *ngIf="filteredTransactions.length === 0" class="no-transactions">
                        {{ form.get('direction')?.value === 'received' ? ('gifts.noIncomeTransactions' | translate) : ('gifts.noExpenseTransactions' | translate) }}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">{{ 'common.notes' | translate }}</label>
            <textarea
                    formControlName="notes"
                    id="notes"
                    [placeholder]="'transactions.notesPlaceholder' | translate"
                    rows="2"
            ></textarea>
        </div>

        <div class="form-actions">
            <button (click)="onCancel()" class="btn btn-secondary" type="button">
                {{ 'common.cancel' | translate }}
            </button>
            <button
                    [disabled]="form.invalid || loading"
                    class="btn btn-primary"
                    type="submit"
            >
                {{ loading ? ('common.saving' | translate) : (isEditMode ? ('common.update' | translate) : ('common.add' | translate)) }}
            </button>
        </div>
    </form>
</div>


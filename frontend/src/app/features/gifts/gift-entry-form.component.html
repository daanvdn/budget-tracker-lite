<div class="form-container">
    <h2>{{ isEditMode ? 'Edit' : 'Add' }} Gift Entry</h2>

    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
    </div>

    <form (ngSubmit)="onSubmit()" [formGroup]="form">
        <div class="form-group">
            <label for="direction">Type *</label>
            <select formControlName="direction" id="direction">
                <option *ngFor="let dir of directions" [value]="dir">
                    {{ formatDirection(dir) }}
                </option>
            </select>
        </div>

        <div class="form-group">
            <label for="person_id">{{ form.get('direction')?.value === 'received' ? 'From' : 'To' }} *</label>
            <div class="beneficiary-select-wrapper">
                <select formControlName="person_id" id="person_id">
                    <option [ngValue]="null" disabled>-- Select Person --</option>
                    <option *ngFor="let b of beneficiaries" [ngValue]="b.id">
                        {{ b.name }}
                    </option>
                </select>
                <button type="button" class="btn-add-new" (click)="toggleNewBeneficiaryInput()" [title]="showNewBeneficiaryInput ? 'Cancel' : 'Add new person'">
                    {{ showNewBeneficiaryInput ? 'Ã—' : '+' }}
                </button>
            </div>
            <div class="new-beneficiary-input" *ngIf="showNewBeneficiaryInput">
                <input
                    type="text"
                    [(ngModel)]="newBeneficiaryName"
                    [ngModelOptions]="{standalone: true}"
                    placeholder="Enter new person name"
                    (keyup.enter)="createNewBeneficiary()"
                />
                <button
                    type="button"
                    class="btn btn-primary btn-small"
                    (click)="createNewBeneficiary()"
                    [disabled]="!newBeneficiaryName.trim() || creatingBeneficiary"
                >
                    {{ creatingBeneficiary ? 'Creating...' : 'Create' }}
                </button>
            </div>
            <div *ngIf="form.get('person_id')?.invalid && form.get('person_id')?.touched" class="error">
                Person is required
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">Amount *</label>
                <input
                        formControlName="amount"
                        id="amount"
                        min="0.01"
                        placeholder="0.00"
                        step="0.01"
                        type="number"
                />
                <div *ngIf="form.get('amount')?.invalid && form.get('amount')?.touched" class="error">
                    Valid amount is required
                </div>
            </div>

            <div class="form-group">
                <label for="gift_date">Date *</label>
                <input
                        formControlName="gift_date"
                        id="gift_date"
                        type="date"
                />
            </div>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <input
                    formControlName="description"
                    id="description"
                    placeholder="e.g., Birthday money"
                    type="text"
            />
        </div>

        <!-- Transaction Linking -->
        <div class="form-group">
            <label>Link to Transaction (Optional)</label>
            <div class="transaction-picker">
                <div *ngIf="selectedTransaction; else noTransaction" class="selected-transaction">
          <span class="transaction-info">
            {{ formatDate(selectedTransaction.transaction_date) }} -
              {{ selectedTransaction.description }}
              ({{ formatCurrency(selectedTransaction.amount) }})
          </span>
                    <button (click)="selectTransaction(null)" class="btn-clear" type="button">âœ•</button>
                </div>
                <ng-template #noTransaction>
                    <button (click)="toggleTransactionPicker()" class="btn-link" type="button">
                        ðŸ”— {{ showTransactionPicker ? 'Hide' : 'Select' }} Transaction
                    </button>
                </ng-template>

                <div *ngIf="showTransactionPicker" class="transaction-list">
                    <div class="transaction-search-hint">
                        Showing {{ form.get('direction')?.value === 'received' ? 'income' : 'expense' }} transactions
                    </div>
                    <div
                            (click)="selectTransaction(t)"
                            *ngFor="let t of filteredTransactions | slice:0:10"
                            class="transaction-option"
                    >
                        <span class="transaction-date">{{ formatDate(t.transaction_date) }}</span>
                        <span class="transaction-desc">{{ t.description }}</span>
                        <span class="transaction-amount">{{ formatCurrency(t.amount) }}</span>
                    </div>
                    <div *ngIf="filteredTransactions.length === 0" class="no-transactions">
                        No matching transactions found
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea
                    formControlName="notes"
                    id="notes"
                    placeholder="Any additional notes..."
                    rows="2"
            ></textarea>
        </div>

        <div class="form-actions">
            <button (click)="onCancel()" class="btn btn-secondary" type="button">
                Cancel
            </button>
            <button
                    [disabled]="form.invalid || loading"
                    class="btn btn-primary"
                    type="submit"
            >
                {{ loading ? 'Saving...' : (isEditMode ? 'Update' : 'Add') }}
            </button>
        </div>
    </form>
</div>


<div class="form-container">
    <h2>{{ isEditMode ? ('gifts.editPurchase' | translate) : ('gifts.addPurchase' | translate) }}</h2>

    <div *ngIf="errorMessage" class="error-message">
        {{ errorMessage }}
    </div>

    <form (ngSubmit)="onSubmit()" [formGroup]="form">
        <div class="form-group">
            <label for="description">{{ 'common.description' | translate }} *</label>
            <input
                    formControlName="description"
                    id="description"
                    placeholder="e.g., LEGO Technic set"
                    type="text"
            />
            <div *ngIf="form.get('description')?.invalid && form.get('description')?.touched" class="error">
                {{ 'gifts.descriptionRequired' | translate }}
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">{{ 'common.amount' | translate }} *</label>
                <input
                        formControlName="amount"
                        id="amount"
                        min="0.01"
                        placeholder="0.00"
                        step="0.01"
                        type="number"
                />
                <div *ngIf="form.get('amount')?.invalid && form.get('amount')?.touched" class="error">
                    {{ 'gifts.amountRequired' | translate }}
                </div>
            </div>

            <div class="form-group">
                <label for="purchase_date">{{ 'gifts.purchaseDate' | translate }} *</label>
                <input
                        formControlName="purchase_date"
                        id="purchase_date"
                        type="date"
                />
            </div>
        </div>

        <!-- Transaction Linking -->
        <div class="form-group">
            <label>{{ 'gifts.linkToTransaction' | translate }}</label>
            <div class="transaction-picker">
                <div *ngIf="selectedTransaction; else noTransaction" class="selected-transaction">
          <span class="transaction-info">
            {{ formatDate(selectedTransaction.transaction_date) }} -
              {{ selectedTransaction.description }}
              ({{ formatCurrency(selectedTransaction.amount) }})
          </span>
                    <button (click)="selectTransaction(null)" class="btn-clear" type="button">âœ•</button>
                </div>
                <ng-template #noTransaction>
                    <button (click)="toggleTransactionPicker()" class="btn-link" type="button">
                        ðŸ”— {{ showTransactionPicker ? ('gifts.hideTransaction' | translate) : ('gifts.selectTransaction' | translate) }}
                    </button>
                </ng-template>

                <div *ngIf="showTransactionPicker" class="transaction-list">
                    <div class="transaction-search-hint">
                        {{ 'gifts.showingExpenseTransactions' | translate }}
                    </div>
                    <div
                            (click)="selectTransaction(t)"
                            *ngFor="let t of expenseTransactions | slice:0:10"
                            class="transaction-option"
                    >
                        <span class="transaction-date">{{ formatDate(t.transaction_date) }}</span>
                        <span class="transaction-desc">{{ t.description }}</span>
                        <span class="transaction-amount">{{ formatCurrency(t.amount) }}</span>
                    </div>
                    <div *ngIf="expenseTransactions.length === 0" class="no-transactions">
                        {{ 'gifts.noExpenseTransactions' | translate }}
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="notes">{{ 'common.notes' | translate }}</label>
            <textarea
                    formControlName="notes"
                    id="notes"
                    [placeholder]="'transactions.notesPlaceholder' | translate"
                    rows="2"
            ></textarea>
        </div>

        <div class="form-actions">
            <button (click)="onCancel()" class="btn btn-secondary" type="button">
                {{ 'common.cancel' | translate }}
            </button>
            <button
                    [disabled]="form.invalid || loading"
                    class="btn btn-primary"
                    type="submit"
            >
                {{ loading ? ('common.saving' | translate) : (isEditMode ? ('common.update' | translate) : ('common.add' | translate)) }}
            </button>
        </div>
    </form>
</div>

